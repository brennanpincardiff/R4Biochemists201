---
title: "R for Biochemists 201 Module 4 - Functions & Packages"
author: "Paul Brennan, Cardiff University, BrennanP@cardiff.ac.uk"
date: "August 2020"
output: html_document
#  word_document: default
#  pdf_document: default
---

### Welcome to Module 4 of the R for Biochemists 201 Training module.

Each module is designed to take approximately 60 minutes to complete. 

The material provided includes text to read, video demonstrations, an example R
script with exercise. We hope you enjoy the modules. We welcome feedback and
 comments. 

### How to use this module 
1. To learn from this module, cut and paste the R code into R-Studio and then run the code line by line. 
2. See if you can make the script work
3. Watch the demonstration videos to see how the code works
4. Look at how the 'Global Environment' changes.
5. Change the code and test it
6. Try the exercises at the end
7. Extend your learning using the resources at the end

### Learning Objectives for Module 4
* Understand & write functions 
* Document a function
* Version Control
* Exploring packages 


As we deepen our knowledge and usage of R, it becomes useful to create functions. Functions can create a workflow, can be combination of other functions or can be a detailed programming or calculations. 
When are you ready to create a function? Well, if you find yourself using the same commands or pieces of workflow multiple times then it suggests that you could benefit from creating a function that brings these together. If you generate data in the same way and analyse in the same way, you could benefit from a workflow that brings together. 
Three is usually the 'magic' number. If you have or plan to repeat the same analysis three times you could probably write better code and reduce your work by writing some functions. 
To create a function, we use the function() function. 
Let's look at Croft Figure 4f.


```{r packages_we_need}
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyr)
```

pagebreak \pagebreak

### The Experiment
We are going to explore the data in 
[Figure 4f](https://www.nature.com/articles/s41586-019-1263-7/figures/4) 
from the Croft (2019) paper. There are panels about Leukocytes, Neutrophils and
Macrophages so we are going to create a function that links together the
workflow for each of the three panels. 

The [data is available](https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-019-1263-7/MediaObjects/41586_2019_1263_MOESM10_ESM.xlsx).

The Excel file has 9 worksheets - each sheet corresponding to a part of 
Figure 4. 

Our workflow is:

1. Import the data
2. Tidy our data (also known as wrangling or munging)
3. Transform or summarise
4. Visualize




### Writing functions
##### First video - writing a function... 
```{r get_data_for_Fig_4f}
link <- "https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-019-1263-7/MediaObjects/41586_2019_1263_MOESM10_ESM.xlsx"

# the download.file() function downloads and saves the file with the name given
download.file(url=link, destfile="file.xlsx", mode="wb")

# check worksheet names 
sheet_names <- excel_sheets("file.xlsx")
data <- read_excel("file.xlsx", sheet_names[6])
```

As with previous data sets from this manuscript the raw data is quite Untidy. 
I have simplified it a little in Excel and it is available to download from
Github with this code.

```{r get_easier_data_for_Fig_4f}
link <- c("https://github.com/brennanpincardiff/R4Biochemists201/blob/master/data/fig_4f.xlsx?raw=true")

# the download.file() function downloads and saves the file with the name given
download.file(url=link, destfile="file.xlsx", mode="wb")

data <- read_excel("file.xlsx")
```


Our workflow is basically the same as before. 
Steps:
1. Extract cell type we want to plot - this will be an argument of our function
2. Transform the data
3. Generate the plot
4. Customise the plot
Usually, I try to make it work for one element and then turn it into a function. Once it is a function, I test it on the original data and then use it on the rest. 
This is the code for our workflow:


```{r first_workflow}
# select out the rows we want with filter() function for "Leucocytes"
# gather without cell_type and treatment
# mutate treatment into a factor to plot in the correct order
data %>% 
    filter(cell_type =="Leucocytes") %>% 
    gather(cell_number, mice, -cell_type, -treatment) %>%
    mutate(treatment = factor(treatment, c("Sham_1", "THY-", "Sham_2","THY+"))) -> data_2

# make the plot
set.seed(1)   # geom_jitter has a random element so set.seed() makes this same
plot_l <- ggplot(data = data_2,
    aes(treatment, mice, colour = treatment)) +
    geom_boxplot() +
    geom_jitter(width=0.15) +
    theme_bw() +
    labs(title = "Leucocytes", x="", y="",
         subtitle = "Croft et al (2019) Nature 570:246–251 (2019)") +
    theme_classic() + theme(legend.position="none")

plot_l
```

Now we turn it into a function. 

```{r make_function}
## make a function called my_workflow

my_workflow <- function(data, a_cell_type){
    # select out the rows we want with filter() function
    data %>% 
        filter(cell_type == a_cell_type) %>% 
        gather(cell_number, mice, -cell_type, -treatment)  %>%    
        mutate(treatment = factor(treatment, c("Sham_1", "THY-", "Sham_2","THY+"))) -> data_2
        
    # make the plot
    set.seed(1)
    plot <- ggplot(data = data_2,
        aes(treatment, mice, colour = treatment)) +
        geom_boxplot() +
        geom_jitter(width=0.15) +
        theme_bw() +
        labs(title = a_cell_type, x="", y="",
             subtitle = "Croft et al (2019) Nature 570:246–251 (2019)") +
        theme_classic() + theme(legend.position="none")
    
    # this returns the plot and is key!  
    return(plot)
}

```

Please note here is that a new part has been created in my Global
Environment entitled Functions. 
In this is the function called my_workflow.

```{r check_function}
# check_function
cell_types <- unique(data$cell_type)
cell_types[1] # this is Leucocytes and should work...
leuco_plot <- my_workflow(data, cell_types[1])
leuco_plot

# do a visual check that the same object as the script above
```


Now use the function to generated two new plots with different cell types. 

```{r use_function}
# now plot for other cell types

cell_types[2] # this is Leucocytes and should work...
neutro_plot <- my_workflow(data, cell_types[2])
macro_plot <- my_workflow(data, cell_types[3])

# now we have three plots all made the same way.

neutro_plot
macro_plot
```


### Exercise 1
Please create a function to add the statistical tests that we have used before. 
As I mentioned, I usually approach this by getting it right for one plot first
and then test and use the function. 
There are different ways to do this but do have a play and try to work out
what to do. 

### Answers for Exercise 1
Here is an example of a function that will add the statistical tests.
```{r exercise_1_answer} 
# use ggpubr
```


### Our second advanced theme is documentation
##### Second video - document your function control... 

We can create functions in our script files or R-markdown files. However, 
if we are using functions across multiple files, we might want to save them
separately.

To do this, create a new R script file with a meaningful name and cut and paste
our fuction. In this case we are making a file called `workflow_fig4f.R`

To use the function, the source() function will bring it into the Global
Environment. 
```{r bring_in_function, eval=FALSE} 
source("/Users/paulbrennan/Documents/R4Biochemists201/R/workflow_fig4f.R")

```

To help other users or our future selves, we are going to document this
function. Documentation is key to your collaborators, remembering what
and why you have done something and if you 
ever want to share your functions or workflows with others. 
We could use hash tags but there are other ways to document functions in 
particular. These use sets of tags called Roxygen tags. 
There is a short cut that will do this Ctrl+Shift+Alt+R. 

The Roxygen tags use #' and @ symbols. Here is an example:

#' Title
#'
#' @param data 
#' @param a_cell_type 
#'
#' @return
#' @export
#'
#' @examples

@param refers to paramaters 
@return tells you what is returned. 
@export is necessary if you are including your function in a package. 

We can add more information so that we know what the function does. 

### Exercise 2
Above I hope that you created your own function to add the statistical tests. 
Please you add the documentation to that now.

### Answers for Exercise 2
Here is my example...


### Version control
##### Third video - version control... 
Version control is a key element of becoming a better programmer. 
It is a way of recording changes you have made to a script, to a function or
to a workflow. One of the most commonly used methods is called Git. 

There is a video shows you how to get R-Studio working with Github, 
how to commit a change and push it online.

### Exercise 3
You will need to create an account for yourself on
[Github.com](https://github.com/).
Then, try creating your own My_Learning_R prjoect on Github. Put in 
a Readme. 
Then clone it into a new R Studio project. Write some code for the analysis of 
some data. Stage it and commit the change onto Github. 
See if you can make it all work together. 
Make more changes and repeat the process. 
Share the address of your Github repo so that we can see
your progress. 
You have taken a key next step towards being a programmer.


pagebreak \pagebreak

### Packages
##### Fourth video - packages 

Packages are group of functions that are available to download and explore. 
There are lots of packages available that you might want to play with. 
You might even want to adapt these to your own workflows, change functions
and even contribute to them as your skills develop. 

Sources of packages:
1. CRAN
2. Bioconductor
3. R-OpenSci
4. Github

A good place to explore for packages is Bioconductor. These are
packages for Bioinformatics and can be used to explore biological data.

For example, perhaps you want to look at some flow data. 
There is a package for that on Bioconductor. 
You need to install the BiocManager and then install the flowCore package. 

```{r download_from_Bioconductor}
# install BiocManager
# install.packages("BiocManager")
# BiocManager::install("flowCore")

library("flowCore")
library("flowViz")
library(ggplot2)

# download a compressed folder of flow data

#with colours indicating density
colfunc <- colorRampPalette(c("white", "lightblue", "green", "yellow", "red"))
# this colour palette can be changed to your taste 



show_FSC_SSC <- function(filename){
    data <- flowCore::read.FCS(filename, alter.names = TRUE)
    vals <- as.data.frame(flowCore::exprs(data))
    return(ggplot(vals, aes(x=FSC.A, y=SSC.A)) +
      ylim(0, 500000) +
      xlim(0,5000000) +
      stat_density2d(geom="tile", aes(fill = ..density..), contour = FALSE) +
      scale_fill_gradientn(colours=colfunc(400)) + # gives the colour plot
      geom_density2d(colour="black", bins=5) +
      annotate("text", x = 10, y = 400000, label = filename)   )# draws the lines inside
}

show_CFSE <- function(filename){
    data <- flowCore::read.FCS(filename, alter.names = TRUE)
    vals <- as.data.frame(flowCore::exprs(data))
    vals_f <- dplyr::filter(vals, FSC.A>1000000)

    return(ggplot(vals_f, aes(x=FL1.H)) + geom_density() +
       xlim(1000,1000000) + scale_x_log10())
}

link1 <- "https://github.com/brennanpincardiff/R4Biochemists201/blob/master/data/20111028_one%20sample%20Bay%20Day%207/A01.fcs?raw=true"
download.file(url=link, destfile="file.fcs", mode="wb")

data <- flowCore::read.FCS("file.fcs", alter.names = TRUE)

show_FSC_SSC(file.fcs)
show_CFSE(file.fcs)


show_CFSE("file.fcs")
show_CFSE(file_names[3], path)


# want two data files with different CFSE profiles....
```

You can download and use a package from Github. 
Explore gganatogram as an example. 

```{r download_from_github}
## install from Github
# remove the hash tag to run. 
#devtools::install_github("jespermaag/gganatogram")
library(gganatogram)
library(dplyr)
library(viridis)
library(gridExtra)

organPlot <- data.frame(organ = c("heart", "leukocyte", "nerve", "brain", "liver", "stomach", "colon"), 
 type = c("circulation", "circulation",  "nervous system", "nervous system", "digestion", "digestion", "digestion"), 
 colour = c("red", "red", "purple", "purple", "orange", "orange", "orange"), 
 value = c(10, 5, 1, 8, 2, 5, 5), 
 stringsAsFactors=F)

 head(organPlot)

gganatogram(data=organPlot, fillOutline='#a6bddb', organism='human', sex='male', fill="colour")

```


### Exercise 4
Download and draw a brain plot using 
https://github.com/LCBC-UiO/ggseg


### Answers Exercise 4
```{r download_ggseg}
# install
# devtools::install_github("LCBC-UiO/ggseg", build_vignettes = TRUE)
library(ggseg)
ggseg(atlas=aseg)

```

It is interesting to check out the details of a package on Github if it
is there. Here is a the Github repo for
[gganatogram](https://github.com/jespermaag/gganatogram). By looking at various
packages you can get a feeling for how they
are organised. Here is a little about how packages are structured. 

Basic anatomy of a package on Github...
- Readme
- Build badge - passing is good.
- R folder - has the code - you can look at this and adapt.
- man folder - has the documentation - it is generated by the Roxygen tags.
- test folder - good packages test their code - the tests are here. 
- Vignettes - some example code that you can explore. 


You can also download all the material from a package as a separate RStudio
project. This will fork the package and you can play, edit, adapt and make
changes if you like. 

There is also a very good
book about [Packages](http://r-pkgs.had.co.nz/) and how they can be organised. 

### Exercise 5
Download and check out the vignette for drawProteins
https://github.com/brennanpincardiff/drawProteins
Use drawProteins to generate a schematic of your favourite protein. 


### Answers Exercise 5
```{r download_drawProteins}
# download drawProteins from Bioconductor
# install BiocManager
# install.packages("BiocManager")
# BiocManager::install("drawProteins")

library(drawProteins)
# show the vignette for drawProteins
vignette("drawProteins_BiocStyle")
# sample code is here... 

# integrate your learning by adding the code and output to the Github page you 
# created above...
```

pagebreak \pagebreak

### Review what we have learned
* We created a function
* We documented our function using Roxygen tags
* We learned the basics of version control using Github
* We looked and explored packages on Bioconductor and Github

### Resources
* [Software Carpentry piece about writing functions](https://swcarpentry.github.io/r-novice-inflammation/02-func-R/) 
* [Object documentation](https://r-pkgs.org/man.html) - chapter on documentation
* [Happy Git and Github for the useR](https://happygitwithr.com/) - helpful advice for using Git with R. 
* [Bioconductor](http://bioconductor.org/) - lots of bioinformatics resources for R. 
* [R Open Sci](https://ropensci.org/) - a great resource for open and reproducible science
* [R Packages](https://r-pkgs.org/) - the definitive book on packages
